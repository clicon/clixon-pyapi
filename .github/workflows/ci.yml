name: Clixon PyAPI CI

on:
  push:
    branches:
      - main
      - test-actions
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      VERSION: "1.1.0"
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          architecture: 'x64'
          cache: 'pip'
      - name: Install dependencies
        run: sudo apt install -y python3 pythpn3-pip python3-setuptools python3-wheel python3-pytest python3-stdeb
      - name: Install requirements
        run: ./requirements-apt.sh
      - name: Test with pytest
        run: pytest
      - name: build Debian package
        run: DEB_BUILD_OPTIONS=nocheck python3 setup.py --command-packages=stdeb.command bdist_deb
      - name: Create deb packet
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{env.VERSION}}_${{env.RUN_NUMBER}}
          release_name: clixon-pyapi_${{env.VERSION}}-${{env.RUN_NUMBER}}
          draft: false
          prerelease: false
      - name: Upload artefact (clixon)
        uses: actions/upload-artifact@v4
        with:
          name: python3-clixon-pyapi_${{env.VERSION}}-1_all.deb
          path: ${{ github.workspace }}/deb_dist/python3-clixon-pyapi_${{env.VERSION}}-1_all.deb
